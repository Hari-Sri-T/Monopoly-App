
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monopoly Dealings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        .monopoly-logo {
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }
        .glass-panel {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .property-card {
            transition: transform 0.2s ease-in-out;
        }
        .property-card:hover {
            transform: translateY(-5px);
        }
        .remove-prop-btn {
            background-color: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border-radius: 9999px;
            width: 24px;
            height: 24px;
            font-weight: bold;
            line-height: 24px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .remove-prop-btn:hover {
             background-color: rgba(239, 68, 68, 0.4);
        }
        .font-cursive { font-family: 'Great Vibes', cursive; }
        
        /* --- NEW STYLES FOR LEADERBOARD --- */
        .title-positive {
            color: #FFD700; /* Gold */
            font-weight: bold;
            text-shadow: 0 0 4px #FFD700, 0 0 8px #FFA500;
        }
        .title-negative {
            color: #444; /* Dark Grey */
            font-weight: bold;
            text-shadow: 0 0 4px #C0C0C0, 0 0 8px #FFFFFF;
        }
        .glowing-text {
            color: #ffffff;
            text-shadow: 0 0 5px #ffffff, 0 0 10px #ffffff, 0 0 15px #ffd700;
        }

    </style>
</head>
<body class="bg-black text-gray-200 antialiased" style="background-image: url('https://i.ibb.co/ZpZn4DGC/Untitled-design-3.png '); background-size: cover; background-position: center; background-attachment: fixed;">

    <div id="error-banner" class="hidden fixed top-0 left-0 right-0 bg-amber-600 text-white p-4 text-center z-50">
        <p id="error-message"></p>
    </div>

    <div id="app-container" class="max-w-lg mx-auto p-4 min-h-screen flex flex-col justify-center">

        <div id="home-view">
            <div class="p-8 rounded-2xl glass-panel">
                <img src="https://i.ibb.co/ndgqQxy/logo.png" alt="Monopoly Logo" class="w-3/4 mx-auto mb-1 monopoly-logo">
                <p class="text-center text-gray-300 mb-8 text-2xl font-cursive">The modern way to play the classic.</p>
                <div class="space-y-4 flex flex-col items-center">
                    <button id="create-game-btn" class="w-5/6 bg-amber-500 text-black font-bold py-4 px-4 rounded-lg shadow-lg hover:bg-amber-600 transition-colors">
                        Create New Game
                    </button>
                    <button id="join-game-btn" class="w-5/6 bg-transparent border-2 border-amber-500 text-amber-500 font-bold py-4 px-4 rounded-lg hover:bg-amber-500 hover:text-black transition-colors">
                        Join Existing Game
                    </button>
                     <button id="leaderboard-btn" class="w-5/6 bg-transparent border-2 border-amber-500 text-amber-500 font-bold py-4 px-4 rounded-lg hover:bg-amber-500 hover:text-black transition-colors">
                        Global Leaderboard
                    </button>
                </div>
            </div>
        </div>
        
        <div id="join-game-view" class="hidden p-8 rounded-2xl glass-panel">
            <h2 class="text-2xl font-bold text-center mb-6 text-white">Enter Game ID</h2>
            <input type="text" id="game-id-input" placeholder="e.g., GAME123" class="w-full p-3 bg-gray-900 border-2 border-gray-700 text-white rounded-lg text-center text-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
            <button id="submit-join-game-btn" class="mt-4 w-full bg-amber-500 text-black font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-amber-600 transition-colors">Join</button>
            <button id="back-to-home-from-join" class="mt-2 w-full text-gray-400 font-bold py-2 px-4 rounded-lg hover:bg-gray-800 transition-colors">Back</button>
        </div>
        
        <div id="player-name-view" class="hidden p-8 rounded-2xl glass-panel">
            <h2 class="text-2xl font-bold text-center mb-6 text-white">Enter Your Name</h2>
            <input type="text" id="player-name-input" placeholder="e.g., Top Hat" class="w-full p-3 bg-gray-900 border-2 border-gray-700 text-white rounded-lg text-center text-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
            <button id="submit-player-name-btn" class="mt-4 w-full bg-amber-500 text-black font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-amber-600 transition-colors">Let's Go!</button>
            <button id="back-to-join-from-name" class="mt-2 w-full text-gray-400 font-bold py-2 px-4 rounded-lg hover:bg-gray-800 transition-colors">Back</button>
        </div>

        <div id="organizer-view" class="hidden p-8 rounded-2xl glass-panel">
            <div class="space-y-6">
                <div>
                    <h2 class="text-2xl font-bold text-center mb-2 text-white">Organizer Dashboard</h2>
                    <div class="text-center bg-gray-800 p-3 rounded-lg">
                        <p class="text-sm text-gray-400">Game ID:</p>
                        <p id="game-id-display" class="text-lg font-bold tracking-widest text-white"></p>
                    </div>
                     <p class="text-center mt-4 text-gray-400">Share this QR Code with players:</p>
                    <div class="mt-2 flex justify-center">
                        <div id="qrcode" class="p-4 bg-white rounded-lg shadow-md"></div>
                    </div>
                    <p class="text-center text-xs text-gray-500 mt-2">Scan using your phone's camera.</p>
                </div>
                <hr class="border-gray-700"/>
                <div>
                    <h3 class="text-xl font-bold mb-4 text-white">Players</h3>
                    <div id="organizer-player-list" class="space-y-4"></div>
                </div>
                <button id="end-game-btn" class="w-full bg-amber-500 text-black font-bold py-3 px-4 rounded-lg hover:bg-amber-600 transition-colors">End Game & Update Leaderboard</button>
                <button id="back-to-home-from-organizer" class="w-full text-gray-400 font-bold py-2 px-4 rounded-lg hover:bg-gray-800 transition-colors">Main Menu</button>
            </div>
        </div>

        <div id="player-view" class="hidden">
            <div class="p-8 rounded-2xl glass-panel space-y-6">
                <div>
                    <div class="relative rounded-xl overflow-hidden mb-4 shadow-lg">
                        <img src="https://i.ibb.co/nNHCGF1y/CARD.png" class="w-full h-auto block" alt="Player Card Background">
                        <div class="absolute bottom-0 left-0 p-4 w-full">
                            
                            <h2 id="player-card-name" class="glowing-text text-2xl font-bold uppercase tracking-wider"></h2>
                        </div>
                    </div>
                    <div class="p-6 rounded-xl text-white text-center" style="background: linear-gradient(to right, #434343, #000000);">
                         <p class="text-sm opacity-70">Balance</p>
                         <p id="player-card-money" class="text-4xl font-bold tracking-wider"></p>
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-3 text-white">My Properties</h3>
                    <div id="player-card-properties" class="grid grid-cols-1 gap-3"></div>
                     <p id="no-properties-msg" class="text-center text-gray-500 mt-6 hidden">You don't own any properties yet.</p>
                </div>
                <div class="flex justify-center">
                    <button id="leave-game-btn" class="w-5/6 text-amber-500 font-bold py-3 px-4 rounded-lg hover:bg-gray-800 transition-colors border-2 border-amber-500">Leave Game</button>
                </div>
            </div>
        </div>
        
        <div id="leaderboard-view" class="hidden p-8 rounded-2xl glass-panel">
            <h2 class="text-3xl font-bold text-center mb-6 text-white">Global Leaderboard</h2>
            <div id="leaderboard-list" class="space-y-3"></div>
            <button id="back-to-home-from-leaderboard" class="mt-6 w-full text-gray-400 font-bold py-3 px-4 rounded-lg hover:bg-gray-800 transition-colors">Back to Main Menu</button>
        </div>
    </div>

    <div id="money-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="glass-panel p-6 rounded-lg shadow-xl w-11/12 max-w-sm">
            <h3 id="money-modal-title" class="text-lg font-bold mb-4 text-white"></h3>
            <input type="number" id="money-modal-amount" placeholder="Amount" class="w-full p-3 bg-gray-800 border-2 border-gray-700 text-white rounded-lg text-center text-xl focus:outline-none focus:ring-2 focus:ring-amber-500" inputmode="numeric" pattern="[0-9]*">
            <div class="mt-4 grid grid-cols-2 gap-2">
                <button id="money-modal-submit" class="w-full bg-amber-500 text-black font-bold py-2 px-4 rounded-lg hover:bg-amber-600 transition-colors">Confirm</button>
                <button id="money-modal-cancel" class="w-full bg-gray-700 text-gray-300 font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="property-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="glass-panel p-6 rounded-lg shadow-xl w-11/12 max-w-sm">
            <h3 id="property-modal-title" class="text-lg font-bold mb-4 text-white"></h3>
            
            <div class="mb-4">
                <h4 class="text-md font-semibold text-gray-300 mb-2">Current Properties:</h4>
                <div id="player-properties-list-modal" class="max-h-40 overflow-y-auto space-y-2 pr-2">
                    </div>
            </div>
            
            <hr class="border-gray-700 mb-4"/>

            <div>
                <h4 class="text-md font-semibold text-gray-300 mb-2">Add New Property:</h4>
                <div class="space-y-3">
                    <input type="text" id="property-name-input" placeholder="Property Name" class="w-full p-3 bg-gray-800 border-2 border-gray-700 text-white rounded-lg text-center text-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                    <input type="number" id="property-price-input" placeholder="Price" class="w-full p-3 bg-gray-800 border-2 border-gray-700 text-white rounded-lg text-center text-lg focus:outline-none focus:ring-2 focus:ring-amber-500" inputmode="numeric">
                    <button id="add-property-submit" class="w-full bg-amber-500 text-black font-bold py-2 px-4 rounded-lg hover:bg-amber-600 transition-colors">Add Property</button>
                </div>
            </div>

             <div class="mt-6">
                <button id="property-modal-cancel" class="w-full bg-gray-700 text-gray-300 font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">Close</button>
            </div>
        </div>
    </div>

    <div id="password-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="glass-panel p-6 rounded-lg shadow-xl w-11/12 max-w-sm">
            <h3 class="text-lg font-bold mb-4 text-white">Organizer Authentication</h3>
            <p class="text-sm text-gray-400 mb-4">Enter the password to create a new game.</p>
            <input type="password" id="password-modal-input" placeholder="Password" class="w-full p-3 bg-gray-800 border-2 border-gray-700 text-white rounded-lg text-center text-xl focus:outline-none focus:ring-2 focus:ring-amber-500">
            <div class="mt-4 grid grid-cols-2 gap-2">
                <button id="password-modal-submit" class="w-full bg-amber-500 text-black font-bold py-2 px-4 rounded-lg hover:bg-amber-600 transition-colors">Authenticate</button>
                <button id="password-modal-cancel" class="w-full bg-gray-700 text-gray-300 font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">Cancel</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, getDocs, writeBatch, increment, orderBy, serverTimestamp, runTransaction, addDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


        // Fetch firebase config from backend
        const configResp = await fetch("/config");
        const { firebaseConfig } = await configResp.json();

        const appId = 'monopoly-dealings-public';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);


        let currentGameId = null;
        let currentPlayerId = null;
        let unsubscribePlayerList = null;
        let unsubscribePlayerCard = null;

        const PROPERTY_COLORS = { 'Brown': '#955436', 'Light Blue': '#aae0fa', 'Pink': '#d93a96', 'Orange': '#f7941d', 'Red': '#ed1b24', 'Yellow': '#fef200', 'Green': '#1fb25a', 'Dark Blue': '#0072bb', 'Railroad': '#000000', 'Utility': '#8a8a8a' };

        const views = {
            home: document.getElementById('home-view'),
            joinGame: document.getElementById('join-game-view'),
            playerName: document.getElementById('player-name-view'),
            organizer: document.getElementById('organizer-view'),
            player: document.getElementById('player-view'),
            leaderboard: document.getElementById('leaderboard-view')
        };
        
        function showView(viewName) {
            Object.values(views).forEach(v => v.classList.add('hidden'));
            if (views[viewName]) {
                views[viewName].classList.remove('hidden');
            }
        }

        function showError(message) {
            const errorBanner = document.getElementById('error-banner');
            document.getElementById('error-message').textContent = message;
            errorBanner.classList.remove('hidden');
            setTimeout(() => {
                errorBanner.classList.add('hidden');
            }, 5000);
        }
        async function validateOrganizerPassword(inputPassword) {
            const resp = await fetch("/auth-organizer", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ password: inputPassword })
            });
            return resp.ok;
        }




        // --- RENDER FUNCTIONS ---
        function renderOrganizerPlayerList(players) {
            const listEl = document.getElementById('organizer-player-list');
            listEl.innerHTML = '';
            if (players.length === 0) {
                listEl.innerHTML = '<p class="text-center text-gray-400">No players have joined yet.</p>';
                return;
            }
            players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = 'bg-gray-800 p-4 rounded-lg shadow flex flex-col space-y-3';
                playerCard.innerHTML = `
                    <div class="flex justify-between items-center">
                        <h4 class="text-lg font-bold text-white">${player.name}</h4>
                        <p class="text-xl font-semibold text-white">$${player.money.toLocaleString()}</p>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <button class="add-money-btn bg-green-500 text-white text-sm font-semibold py-2 rounded hover:bg-green-600" data-player-id="${player.id}" data-player-name="${player.name}">Add $</button>
                        <button class="remove-money-btn bg-red-500 text-white text-sm font-semibold py-2 rounded hover:bg-red-600" data-player-id="${player.id}" data-player-name="${player.name}">Take $</button>
                        <button class="assign-property-btn bg-blue-500 text-white text-sm font-semibold py-2 rounded hover:bg-blue-600" data-player-id="${player.id}" data-player-name="${player.name}">Properties</button>
                    </div>
                `;
                listEl.appendChild(playerCard);
            });
            attachOrganizerButtonListeners();
        }

        function renderPlayerCard(player) {
            if(!player) return;
            document.getElementById('player-card-name').textContent = player.name;
            document.getElementById('player-card-money').textContent = `$${player.money.toLocaleString()}`;
            const propertiesEl = document.getElementById('player-card-properties');
            const noPropMsg = document.getElementById('no-properties-msg');
            propertiesEl.innerHTML = '';
            if (!player.properties || player.properties.length === 0) {
                 noPropMsg.classList.remove('hidden');
            } else {
                 noPropMsg.classList.add('hidden');
                 player.properties.sort((a,b) => a.name.localeCompare(b.name)).forEach(prop => {
                    const propCard = document.createElement('div');
                    propCard.className = 'p-3 rounded-lg flex items-center shadow property-card bg-gray-800';
                    propCard.innerHTML = `<div class="flex-grow"><p class="font-bold text-white">${prop.name}</p><p class="text-sm text-gray-400">$${prop.price.toLocaleString()}</p></div>`;
                    propertiesEl.appendChild(propCard);
                 });
            }
        }
        
        function renderPropertyModalList(playerId, playerName, playerProperties) {
            const listEl = document.getElementById('player-properties-list-modal');
             document.getElementById('property-modal-title').textContent = `Manage ${playerName}'s Properties`;
            listEl.innerHTML = '';

            if (!playerProperties || playerProperties.length === 0) {
                listEl.innerHTML = '<p class="text-center text-gray-400 text-sm">No properties yet.</p>';
            } else {
                playerProperties.sort((a,b) => a.name.localeCompare(b.name)).forEach(prop => {
                    const propItem = document.createElement('div');
                    propItem.className = 'flex items-center justify-between bg-gray-700 p-2 rounded';
                    propItem.innerHTML = `
                        <div>
                            <p class="font-semibold text-white">${prop.name}</p>
                            <p class="text-xs text-gray-400">$${prop.price.toLocaleString()}</p>
                        </div>
                        <div class="remove-prop-btn" data-prop-name="${prop.name}" data-prop-price="${prop.price}">Ã—</div>
                    `;
                    listEl.appendChild(propItem);
                });
            }
            // Attach listeners to new remove buttons
            listEl.querySelectorAll('.remove-prop-btn').forEach(btn => {
                btn.onclick = async () => {
                    const propertyToRemove = {
                        name: btn.dataset.propName,
                        price: parseInt(btn.dataset.propPrice)
                    };
                    const playerRef = doc(db, `artifacts/${appId}/public/data/games/${currentGameId}/players`, playerId);
                    await updateDoc(playerRef, { properties: arrayRemove(propertyToRemove) });
                    // The onSnapshot listener will handle re-rendering the modal list
                };
            });
        }
        
        // --- UPDATED RENDER LEADERBOARD FUNCTION ---
        async function renderLeaderboard() {
            const listEl = document.getElementById('leaderboard-list');
            listEl.innerHTML = `<p class="text-center text-gray-400">Loading scores...</p>`;
            
            const leaderboardCol = collection(db, `artifacts/${appId}/public/data/monopoly-leaderboard`);
            const q = query(leaderboardCol, orderBy("totalMoney", "desc"));
            const snapshot = await getDocs(q);

            if (snapshot.empty) {
                listEl.innerHTML = `<p class="text-center text-gray-400">No games have been recorded yet.</p>`;
                return;
            }

            listEl.innerHTML = '';
            const players = snapshot.docs;
            const totalPlayers = players.length;

            players.forEach((doc, index) => {
                const rank = index + 1;
                const data = doc.data();
                let title = '';
                let titleClass = '';

                // Top 3 Titles
                if (rank === 1) { title = 'God of Wealth'; titleClass = 'title-positive'; }
                else if (rank === 2) { title = 'Fortune Favoured'; titleClass = 'title-positive'; }
                else if (rank === 3) { title = 'Tycoon'; titleClass = 'title-positive'; }

                // Bottom 3 Titles (only if more than 9 players)
                if (totalPlayers > 9) {
                    if (rank === totalPlayers) { title = 'God of Poverty'; titleClass = 'title-negative'; }
                    else if (rank === totalPlayers - 1) { title = 'Unlucky Soul'; titleClass = 'title-negative'; }
                    else if (rank === totalPlayers - 2) { title = 'Broke Man'; titleClass = 'title-negative'; }
                }

                const titleHtml = title ? `<span class="text-sm ml-2 ${titleClass}">${title}</span>` : '';

                const entry = document.createElement('div');
                entry.className = 'bg-gray-800 p-4 rounded-lg shadow flex items-center';
                const medal = rank === 1 ? 'ðŸ¥‡' : rank === 2 ? 'ðŸ¥ˆ' : rank === 3 ? 'ðŸ¥‰' : `#${rank}`;
                
                entry.innerHTML = `
                    <div class="text-2xl font-bold w-12 text-center text-white">${medal}</div>
                    <div class="flex-grow">
                        <div class="flex items-center">
                            <p class="font-bold text-lg text-white">${data.playerName}</p>
                            ${titleHtml}
                        </div>
                        <p class="text-sm text-gray-400">Last played: ${data.lastPlayed.toDate().toLocaleDateString()}</p>
                    </div>
                    <div class="text-xl font-bold ${data.totalMoney < 0 ? 'text-red-500' : 'text-green-400'}">$${data.totalMoney.toLocaleString()}</div>
                `;
                listEl.appendChild(entry);
            });
        }

        // --- EVENT LISTENERS ---
        function attachOrganizerButtonListeners() {
            document.querySelectorAll('.add-money-btn').forEach(btn => btn.onclick = () => openMoneyModal(btn.dataset.playerId, btn.dataset.playerName, 'add'));
            document.querySelectorAll('.remove-money-btn').forEach(btn => btn.onclick = () => openMoneyModal(btn.dataset.playerId, btn.dataset.playerName, 'remove'));
            document.querySelectorAll('.assign-property-btn').forEach(btn => btn.onclick = () => openPropertyModal(btn.dataset.playerId, btn.dataset.playerName));
        }
        
        // --- UPDATED: create-game-btn now opens password modal ---
        document.getElementById('create-game-btn').onclick = () => {
            document.getElementById('password-modal').classList.remove('hidden');
            document.getElementById('password-modal-input').focus();
        };

        document.getElementById('join-game-btn').onclick = () => showView('joinGame');
        document.getElementById('leaderboard-btn').onclick = () => {
            renderLeaderboard();
            showView('leaderboard');
        };
        document.getElementById('back-to-home-from-join').onclick = () => showView('home');
        document.getElementById('back-to-home-from-organizer').onclick = leaveGame;
        document.getElementById('back-to-home-from-leaderboard').onclick = () => showView('home');
        document.getElementById('end-game-btn').onclick = endGame;
        document.getElementById('leave-game-btn').onclick = () => leaveGame(false);
        document.getElementById('submit-join-game-btn').onclick = joinGame;
        document.getElementById('submit-player-name-btn').onclick = registerPlayer;
        document.getElementById('back-to-join-from-name').onclick = () => showView('joinGame');
        
        // --- NEW: Listeners for the password modal ---
        document.getElementById('password-modal-cancel').onclick = () => document.getElementById('password-modal').classList.add('hidden');
        document.getElementById('password-modal-submit').onclick = async () => {
            const passwordInput = document.getElementById('password-modal-input');
            if (await validateOrganizerPassword(passwordInput.value)) {
                passwordInput.value = ''; 
                document.getElementById('password-modal').classList.add('hidden');
                createNewGame();
            } else {
                showError("Incorrect password. Please try again.");
                passwordInput.value = ''; 
            }
        };



        // --- MODAL LOGIC ---
        let moneyModalContext = {};
        function openMoneyModal(playerId, playerName, type) {
            moneyModalContext = { playerId, type };
            document.getElementById('money-modal-title').textContent = `${type === 'add' ? 'Add' : 'Take'} Money for ${playerName}`;
            document.getElementById('money-modal-amount').value = '';
            document.getElementById('money-modal').classList.remove('hidden');
            document.getElementById('money-modal-amount').focus();
        }
        document.getElementById('money-modal-submit').onclick = async () => {
            const amount = parseInt(document.getElementById('money-modal-amount').value);
            if (isNaN(amount) || amount <= 0) return;
            const { playerId, type } = moneyModalContext;
            const playerDocRef = doc(db, `artifacts/${appId}/public/data/games/${currentGameId}/players`, playerId);
            await updateDoc(playerDocRef, { money: increment(type === 'add' ? amount : -amount) });
            document.getElementById('money-modal').classList.add('hidden');
        };
        document.getElementById('money-modal-cancel').onclick = () => document.getElementById('money-modal').classList.add('hidden');

        let propertyModalUnsubscribe = null;
        async function openPropertyModal(playerId, playerName) {
            // Unsubscribe from any previous listener
            if (propertyModalUnsubscribe) propertyModalUnsubscribe();

            const playerRef = doc(db, `artifacts/${appId}/public/data/games/${currentGameId}/players`, playerId);
            
            // Listen for real-time updates to the player's properties
            propertyModalUnsubscribe = onSnapshot(playerRef, (docSnap) => {
                if (docSnap.exists()) {
                    renderPropertyModalList(playerId, playerName, docSnap.data().properties || []);
                }
            });

            document.getElementById('add-property-submit').onclick = () => handleAddProperty(playerId);
            document.getElementById('property-modal').classList.remove('hidden');
        }
        
        async function handleAddProperty(playerId) {
            const nameInput = document.getElementById('property-name-input');
            const priceInput = document.getElementById('property-price-input');
            const propertyName = nameInput.value.trim();
            const propertyPrice = parseInt(priceInput.value);

            if (!propertyName || isNaN(propertyPrice) || propertyPrice <= 0) {
                showError("Please enter a valid property name and price.");
                return;
            }

            // Check if property already exists
            const playersCol = collection(db, `artifacts/${appId}/public/data/games/${currentGameId}/players`);
            const querySnapshot = await getDocs(playersCol);
            let owner = null;
            querySnapshot.forEach(doc => {
                const playerData = doc.data();
                if (playerData.properties && playerData.properties.some(p => p.name.toLowerCase() === propertyName.toLowerCase())) {
                    owner = playerData.name;
                }
            });

            if (owner) {
                showError(`'${propertyName}' is already owned by ${owner}.`);
                return;
            }

            // If not owned, add it
            const newProperty = { name: propertyName, price: propertyPrice };
            const playerRef = doc(db, `artifacts/${appId}/public/data/games/${currentGameId}/players`, playerId);
            await updateDoc(playerRef, { properties: arrayUnion(newProperty) });
            
            nameInput.value = '';
            priceInput.value = '';
        }

        document.getElementById('property-modal-cancel').onclick = () => {
            if (propertyModalUnsubscribe) propertyModalUnsubscribe();
            propertyModalUnsubscribe = null;
            document.getElementById('property-modal').classList.add('hidden');
        };
        
        // --- FIREBASE CORE LOGIC ---

        async function createNewGame() {
            const createBtn = document.getElementById('create-game-btn');
            createBtn.disabled = true;
            createBtn.textContent = 'Creating...';

            try {
                const gamesCollectionPath = `artifacts/${appId}/public/data/games`; // Path for logging
                console.log(`[ORGANIZER] Creating game in collection: '${gamesCollectionPath}'`); // <-- ADDED LOGGING

                const gamesCollection = collection(db, gamesCollectionPath);
                const newGameDoc = await addDoc(gamesCollection, { createdAt: serverTimestamp() });
                currentGameId = newGameDoc.id;
                enterOrganizerMode(currentGameId);
            } catch (error) {
                console.error("Error creating game:", error);
                showError("Could not create game. Please check Firestore rules and configuration.");
                createBtn.disabled = false;
                createBtn.textContent = 'Create New Game';
            }
        }

        async function joinGame() {
            const gameId = document.getElementById('game-id-input').value.trim();
            if (!gameId) return;

            console.log(`[PLAYER] Searching for game with exact ID: '${gameId}'`);

            const gameRef = doc(db, `artifacts/${appId}/public/data/games`, gameId);
            
            try {
                const gameSnap = await getDoc(gameRef); // Use the simpler getDoc
                if (gameSnap.exists()) {
                    console.log("[PLAYER] Game found successfully!");
                    currentGameId = gameId;
                    showView('playerName');
                } else {
                    console.error("[PLAYER] Game not found in database.");
                    showError("Game ID not found. Please double-check the ID is correct.");
                }
            } catch (error) {
                console.error("[PLAYER] An error occurred while fetching the game:", error);
                showError("An error occurred. Please check the console for details.");
            }
        }

        async function registerPlayer() {
            const playerName = document.getElementById('player-name-input').value.trim();
            if (!playerName || !currentGameId) return;

            const playersCollection = collection(db, `artifacts/${appId}/public/data/games/${currentGameId}/players`);
            const newPlayerDoc = await addDoc(playersCollection, { name: playerName, money: 1500, properties: [] });
            currentPlayerId = newPlayerDoc.id;
            
            sessionStorage.setItem('monopoly-gameId', currentGameId);
            sessionStorage.setItem('monopoly-playerId', currentPlayerId);
            enterPlayerMode(currentGameId, currentPlayerId);
        }
        
        function enterOrganizerMode(gameId) {
            document.getElementById('game-id-display').textContent = gameId;
            const qrcodeContainer = document.getElementById('qrcode');
            qrcodeContainer.innerHTML = '';
            new QRCode(qrcodeContainer, { text: window.location.href.split('?')[0] + `?gameId=${gameId}`, width: 192, height: 192 });

            const playersCol = collection(db, `artifacts/${appId}/public/data/games/${gameId}/players`);
            unsubscribePlayerList = onSnapshot(playersCol, (snapshot) => {
                const players = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderOrganizerPlayerList(players);
            });
            showView('organizer');
        }

        function enterPlayerMode(gameId, playerId) {
            const playerDocRef = doc(db, `artifacts/${appId}/public/data/games/${gameId}/players`, playerId);
            unsubscribePlayerCard = onSnapshot(playerDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    renderPlayerCard(docSnap.data());
                } else {
                    leaveGame(true);
                }
            });
            showView('player');
        }

        async function endGame() {
            if (!currentGameId) return;
            const playersCol = collection(db, `artifacts/${appId}/public/data/games/${currentGameId}/players`);
            const playersSnapshot = await getDocs(playersCol);
            
            const leaderboardCol = collection(db, `artifacts/${appId}/public/data/monopoly-leaderboard`);
            const batch = writeBatch(db);

            playersSnapshot.forEach(playerDoc => {
                const data = playerDoc.data();
                const totalMoney = data.money + (data.properties || []).reduce((sum, prop) => sum + prop.price, 0);
                const leaderboardRef = doc(leaderboardCol, data.name);
                batch.set(leaderboardRef, {
                    playerName: data.name,
                    totalMoney: increment(totalMoney),
                    gamesPlayed: increment(1),
                    lastPlayed: serverTimestamp()
                }, { merge: true });
            });
            await batch.commit();

            leaveGame();
        }

        function leaveGame(wasRemoved = false) {
            document.getElementById('create-game-btn').disabled = false;
            document.getElementById('create-game-btn').textContent = 'Create New Game';

            if (unsubscribePlayerList) unsubscribePlayerList();
            if (unsubscribePlayerCard) unsubscribePlayerCard();
            
            if (!wasRemoved) {
                const gameId = sessionStorage.getItem('monopoly-gameId');
                const playerId = sessionStorage.getItem('monopoly-playerId');
                if (gameId && playerId) {
                    const playerRef = doc(db, `artifacts/${appId}/public/data/games/${gameId}/players`, playerId);
                    deleteDoc(playerRef);
                }
            }

            sessionStorage.removeItem('monopoly-gameId');
            sessionStorage.removeItem('monopoly-playerId');
            currentGameId = null;
            currentPlayerId = null;
            
            showView('home');
        }

        async function initializeAuth() {
            console.log("Attempting to sign in..."); // Log start
            return new Promise((resolve, reject) => {
                try {
                    const signInPromise = (typeof __initial_auth_token !== 'undefined' && __initial_auth_token)
                        ? signInWithCustomToken(auth, __initial_auth_token)
                        : signInAnonymously(auth);

                    signInPromise.then(userCredential => {
                        // This block runs on SUCCESS
                        console.log("%cSign-in SUCCESSFUL!", "color: green; font-weight: bold;");
                        console.log("User UID:", userCredential.user.uid);
                        resolve(userCredential);
                    }).catch(error => {
                        // This block runs on FAILURE
                        console.error("%cSign-in FAILED.", "color: red; font-weight: bold;");
                        console.error("Firebase Auth Error:", error);
                        reject(error);
                    });
                } catch (error) {
                    console.error("A critical error occurred in the auth initialization block:", error);
                    reject(error);
                }
            });
        }

        async function initialize() {
            try {
                await initializeAuth();
            } catch (error) {
                console.error("Firebase authentication failed. App may not work correctly.", error);
                showError("Could not connect to the game service. Please refresh and try again.");
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const urlGameId = urlParams.get('gameId');

            if (urlGameId) {
                document.getElementById('game-id-input').value = urlGameId;
                await joinGame();
                return;
            }

            const savedGameId = sessionStorage.getItem('monopoly-gameId');
            const savedPlayerId = sessionStorage.getItem('monopoly-playerId');

            if (savedGameId && savedPlayerId) {
                currentGameId = savedGameId;
                currentPlayerId = savedPlayerId;
                enterPlayerMode(savedGameId, savedPlayerId);
            } else {
                 showView('home');
            }
        }
        
        initialize();
    </script>
</body>
</html>
